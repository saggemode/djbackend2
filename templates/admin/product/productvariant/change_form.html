{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<script>
(function($) {
    'use strict';
    
    $(document).ready(function() {
        var productSelect = $('#id_product');
        var variantTypeSelect = $('#id_variant_type');
        var variantNameField = $('#id_name');
        
        // Store product data
        var productData = {};
        
        // Initialize product data from the page by parsing the option text
        productSelect.find('option').each(function() {
            var option = $(this);
            var productId = option.val();
            var optionText = option.text();
            
            if (productId && optionText) {
                // Parse sizes and colors from the option text
                var sizes = [];
                var colors = [];
                
                // Extract sizes from [Sizes: S,M,L,XL] format
                var sizesMatch = optionText.match(/\[Sizes: ([^\]]+)\]/);
                if (sizesMatch) {
                    sizes = sizesMatch[1].split(',').map(function(size) {
                        return size.trim();
                    });
                }
                
                // Extract colors from [Colors: Red,Blue,Green] format
                var colorsMatch = optionText.match(/\[Colors: ([^\]]+)\]/);
                if (colorsMatch) {
                    colors = colorsMatch[1].split(',').map(function(color) {
                        return color.trim();
                    });
                }
                
                productData[productId] = {
                    sizes: sizes,
                    colors: colors
                };
            }
        });
        
        // Function to update variant name options
        function updateVariantOptions() {
            var productId = productSelect.val();
            var variantType = variantTypeSelect.val();
            
            if (!productId || !variantType) {
                // Reset to text input if no product or variant type selected
                if (variantNameField.is('select')) {
                    variantNameField.replaceWith('<input type="text" name="name" id="id_name" class="vTextField" maxlength="100">');
                }
                return;
            }
            
            var options = [];
            if (variantType === 'size' && productData[productId]) {
                options = productData[productId].sizes;
            } else if (variantType === 'color' && productData[productId]) {
                options = productData[productId].colors;
            }
            
            if (options.length > 0) {
                // Create select dropdown with options
                var selectHtml = '<select name="name" id="id_name" class="vTextField">';
                selectHtml += '<option value="">---------</option>';
                
                options.forEach(function(option) {
                    selectHtml += '<option value="' + option + '">' + option + '</option>';
                });
                
                selectHtml += '</select>';
                
                // Replace the input field with select dropdown
                variantNameField.replaceWith(selectHtml);
                
                // Add a helpful label
                var label = variantNameField.closest('.form-row').find('label[for="id_name"]');
                if (label.length > 0) {
                    label.text('Variant Name (' + variantType.charAt(0).toUpperCase() + variantType.slice(1) + ' Options)');
                }
            } else {
                // Reset to text input if no options available
                if (variantNameField.is('select')) {
                    variantNameField.replaceWith('<input type="text" name="name" id="id_name" class="vTextField" maxlength="100">');
                }
                
                // Reset label
                var label = variantNameField.closest('.form-row').find('label[for="id_name"]');
                if (label.length > 0) {
                    label.text('Variant Name');
                }
            }
        }
        
        // Bind events
        productSelect.on('change', updateVariantOptions);
        variantTypeSelect.on('change', updateVariantOptions);
        
        // Initial setup if values are already selected
        if (productSelect.val() && variantTypeSelect.val()) {
            updateVariantOptions();
        }
    });
    
})(django.jQuery);
</script>
{% endblock %} 